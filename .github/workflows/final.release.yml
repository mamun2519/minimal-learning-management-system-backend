name: Create Release

on:
  workflow_run:
    # ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá ‡¶®‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Build and Deploy YML ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡ßá‡¶≤‡ßá
    workflows: ["Build, Test & Deploy"]
    types:
      - completed

permissions:
  contents: write # ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ‡¶ß‡¶æ‡¶™ ‡ßß: Artifact ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ü‡¶ó‡ßá‡¶∞ YML-‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
      # ... (unzip fix ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®) ...
      - name: Download Artifact Zip Data
        uses: actions/github-script@v6
        id: download
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            // ‚ö°Ô∏è FIX: Artifact-‡¶è‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            const matchArtifact = artifacts.artifacts.find(artifact => artifact.name === 'release-data-artifact'); 

            if (!matchArtifact) {
              core.setFailed('Could not find artifact release-data-artifact'); // erorr message change
              return;
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });

            const fs = require('fs');
            fs.writeFileSync('release-data.zip', Buffer.from(download.data));

      # ‡¶ß‡¶æ‡¶™ ‡ß®: ZIP ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Ü‡¶®‡¶ú‡¶ø‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶®‡ßÅ‡¶®
      - name: Unzip and Load Tag Data
        id: load_data
        run: |
          # unzip ‡¶è‡¶¨‡¶Ç ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°
          unzip release-data.zip -d release-data

          echo "### Loaded release_data.txt contents ###" # ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
          cat release-data/release_data.txt # ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
          echo "########################################"

          # ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡ßá GITHUB_ENV ‡¶§‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ

          # VERSION_TAG ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
          VERSION_TAG=$(grep "^VERSION_TAG=" release-data/release_data.txt | cut -d'=' -f2)
          echo "RELEASE_VERSION=$VERSION_TAG" >> $GITHUB_ENV

          # FULL_IMAGE_NAME ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
          FULL_IMAGE_NAME=$(grep "^FULL_IMAGE_NAME=" release-data/release_data.txt | cut -d'=' -f2)
          echo "IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV

          # DOCKER_TAGS ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
          DOCKER_TAGS=$(grep "^DOCKER_TAGS=" release-data/release_data.txt | cut -d'=' -f2)
          echo "DOCKER_TAGS=$DOCKER_TAGS" >> $GITHUB_ENV

          echo "‚úÖ Environment variables set successfully."
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          # vX.Y.Z ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
          tag_name: ${{ env.RELEASE_VERSION }}
          name: Release ${{ env.RELEASE_VERSION }}

          body: |
            üöÄ **New Release Published**

            This release corresponds to the tag **${{ env.RELEASE_VERSION }}**

            ### Docker Images Pushed
            The application was built and pushed with the following tags:
            - **Version Tag:** `${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}`
            - **Latest Tag:** `${{ env.IMAGE_NAME }}:latest`
            - **All Tags:** `${{ env.DOCKER_TAGS }}`

            ---

            View build workflow run: ${{ github.event.workflow_run.html_url }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
