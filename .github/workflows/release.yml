name: Release Workflow
on:
  workflow_run:
    workflow: ["Build and Push Docker Image"]
    types:
      - completed

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3
        # Step 1: Generate changelog from conventional commits4
      # - name: Create GitHub Release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: v${{ github.event.workflow_run.run_number }}
      #     name: Release v${{ github.event.workflow_run.run_number }}
      #     body: |
      #       ## Changes in this release
      #       - Automated release based on successful Docker image build.
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Changelog
        uses: mikeal/merge-release-action@v1
        with:
          configuration: "default"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # step - 3: Publish Release
      - name: Create Release
        uses: actions/create-release@v1
        body: |
          üöÄ **New Release Published**
          - Version: `${{ env.IMAGE_TAG }}`
          - Docker Image: `${{ secrets.DOCKERHUB_USERNAME }}/lms-backend:${{ env.IMAGE_TAG }}`

          üìù **Changelog:**
          ${{ steps.changelog.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
